<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lashker's Server</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Minimal clean styling */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f9;color:#111}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#0b63d6;color:white}
    header h1{font-size:18px;margin:0}
    #controls{display:flex;gap:8px;align-items:center;margin-left:auto}
    .btn{background:white;color:#0b63d6;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:#0b63d6;color:white}
    #app{display:flex;height:calc(100vh - 60px)}
    #sidebar{width:340px;padding:12px;box-sizing:border-box;border-right:1px solid #e4e7eb;background:white}
    #main{flex:1;padding:12px;overflow:auto}
    #memberList{display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 140px);overflow:auto;padding-right:8px}
    .memberCard{display:flex;gap:12px;align-items:center;background:white;padding:8px;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .memberCard img{width:64px;height:64px;border-radius:8px;object-fit:cover;background:#eee}
    .meta{flex:1}
    .meta h3{margin:0 0 4px 0;font-size:16px}
    .meta p{margin:0;font-size:13px;color:#555}
    #addBtn{position:fixed;right:18px;bottom:18px;width:64px;height:64px;border-radius:50%;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.12);background:#0b63d6;color:white;border:none;cursor:pointer}
    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;backdrop-filter: blur(2px)}
    .modal .card{background:white;padding:16px;border-radius:10px;max-width:700px;width:100%;max-height:90vh;overflow:auto}
    .form-row{display:flex;gap:8px;margin-bottom:10px}
    .form-row input[type="text"], .form-row select, textarea, input[type="file"], input[type="date"]{width:100%;padding:8px;border:1px solid #dfe6ef;border-radius:6px}
    textarea{min-height:80px}
    .small{font-size:12px;color:#666;margin-bottom:8px}
    .top-left-search{display:flex;gap:8px;align-items:center}
    #gmailList{font-size:13px;color:#333;padding:8px;background:#fff;border-radius:8px;max-height:220px;overflow:auto}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Lashker's Server</h1>
    <div id="controls">
      <div class="top-left-search">
        <input id="globalSearch" placeholder="Search members..." style="padding:8px;border-radius:8px;border:none;min-width:220px"/>
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option>Hawker</option>
          <option>Customer</option>
          <option>Store keeper</option>
          <option>Worker</option>
          <option>Owner</option>
        </select>
      </div>
      <button id="settingsBtn" class="btn">Settings</button>
      <button id="signBtn" class="btn">Sign In</button>
    </div>
  </header>

  <div id="app">
    <aside id="sidebar">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <div id="userInfo" style="flex:1">
          <div class="muted">Not signed in</div>
        </div>
        <button id="openAdd" class="btn primary">+ Add</button>
      </div>

      <h3 style="margin-top:0">Members</h3>
      <div id="memberList"></div>

      <div style="margin-top:12px">
        <strong>Signed Gmail IDs (Settings)</strong>
        <div id="gmailList" class="muted">No logins yet</div>
      </div>
    </aside>

    <main id="main">
      <h2>Home</h2>
      <p class="small">List of members (live). Use search and category filter to narrow results.</p>
      <div id="mainContent" style="margin-top:10px">
        <div id="memberListMain"></div>
      </div>
    </main>
  </div>

  <button id="addBtn" title="Add member">+</button>

  <!-- Add / Edit Modal -->
  <div id="modal" class="modal" style="display:none">
    <div class="card">
      <h3>Add Member</h3>
      <div class="small">Add a new identity. To finish (Done) you must be signed in with Google. Password required to allow add: <strong>-@LashkerA01</strong></div>

      <div class="form-row">
        <div style="flex:1">
          <label class="small">Photo</label>
          <input id="photoInput" type="file" accept="image/*"/>
        </div>
        <div style="flex:1">
          <label class="small">Name</label>
          <input id="nameInput" type="text"/>
        </div>
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label class="small">Custom ID</label>
          <input id="idInput" type="text"/>
        </div>
        <div style="flex:1">
          <label class="small">Category</label>
          <select id="categoryInput">
            <option>Hawker</option>
            <option>Customer</option>
            <option>Store keeper</option>
            <option>Worker</option>
            <option>Owner</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:8px">
        <label class="small">Details</label>
        <textarea id="detailInput"></textarea>
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label class="small">Date of joining</label>
          <input id="dateInput" type="date"/>
        </div>
        <div style="flex:1">
          <label class="small">Add password (required to allow add)</label>
          <input id="masterPass" type="text" placeholder="Enter master password"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="doneBtn" class="btn primary">Done</button>
      </div>
      <div id="modalMsg" class="small muted" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" style="display:none">
    <div class="card">
      <h3>Settings & Gmail Logins</h3>
      <div class="small">Gmail addresses of users who signed in are saved here.</div>
      <div style="margin-top:10px"><button id="closeSettings" class="btn">Close</button></div>
      <div style="margin-top:12px" id="settingsGmails"></div>
    </div>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    // === CONFIGURE these with YOUR Firebase project keys ===
    // Get them from Project Settings -> Web SDK config
    const firebaseConfig = {
      apiKey:  "AIzaSyC_Fb5v7vab-JLg2waIvQFnabEOInt1Lrw",
      authDomain: "lasker-server.firebaseapp.com",
      databaseURL: "https://lasker-server-default-rtdb.firebaseio.com",
      projectId: "lasker-server",
      storageBucket: "lasker-server.firebasestorage.app",
      messagingSenderId: "1412659898",
      appId: "1:1412659898:web:a8899e4bd46c6809f8a083",
      measurementId: "G-KKSL8EQRML"
    };
    // ======================================================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref as dbRef, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI elements
    const signBtn = document.getElementById('signBtn');
    const userInfo = document.getElementById('userInfo');
    const openAdd = document.getElementById('openAdd');
    const addBtn = document.getElementById('addBtn');
    const modal = document.getElementById('modal');
    const cancelBtn = document.getElementById('cancelBtn');
    const doneBtn = document.getElementById('doneBtn');
    const photoInput = document.getElementById('photoInput');
    const nameInput = document.getElementById('nameInput');
    const idInput = document.getElementById('idInput');
    const categoryInput = document.getElementById('categoryInput');
    const detailInput = document.getElementById('detailInput');
    const dateInput = document.getElementById('dateInput');
    const masterPass = document.getElementById('masterPass');
    const modalMsg = document.getElementById('modalMsg');
    const memberList = document.getElementById('memberList');
    const memberListMain = document.getElementById('memberListMain');
    const globalSearch = document.getElementById('globalSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const gmailList = document.getElementById('gmailList');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const settingsGmails = document.getElementById('settingsGmails');
    const closeSettings = document.getElementById('closeSettings');

    // In-memory temporary form state (allow filling without login)
    let tempForm = {};

    // Utility: format date
    function formatDate(d) {
      if(!d) return '';
      const dt = new Date(d);
      if (isNaN(dt)) return d;
      return dt.toLocaleDateString();
    }

    // Auth UI
    signBtn.addEventListener('click', async () => {
      if (auth.currentUser) {
        await signOut(auth);
      } else {
        try {
          await signInWithPopup(auth, provider);
        } catch(e){
          alert("Sign in failed: "+e.message);
        }
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userInfo.innerHTML = `<div><strong>${user.displayName || user.email}</strong><div style="font-size:13px;color:#dff">Signed in</div></div>`;
        signBtn.textContent = "Sign Out";
        // Save logged-in email to /logins
        const email = user.email || "unknown";
        const logRef = push(dbRef(db, 'logins'));
        set(logRef, { email, uid: user.uid, ts: Date.now() });
      } else {
        userInfo.innerHTML = `<div class="muted">Not signed in</div>`;
        signBtn.textContent = "Sign In";
      }
    });

    // Open add modal
    function openModal() {
      modal.style.display = 'flex';
      modalMsg.textContent = '';
      // restore temp values if any
      nameInput.value = tempForm.name || '';
      idInput.value = tempForm.customId || '';
      categoryInput.value = tempForm.category || 'Hawker';
      detailInput.value = tempForm.detail || '';
      dateInput.value = tempForm.joinDate || '';
      masterPass.value = '';
    }
    openAdd.addEventListener('click', openModal);
    addBtn.addEventListener('click', openModal);

    cancelBtn.addEventListener('click', () => {
      modal.style.display = 'none';
      // save temp
      tempForm = {
        name: nameInput.value,
        customId: idInput.value,
        category: categoryInput.value,
        detail: detailInput.value,
        joinDate: dateInput.value
      };
    });

    // Save member to Firebase (requires auth)
    async function saveMemberToFirebase(member, file) {
      try {
        const membersRef = dbRef(db, 'members');
        // if file present, upload to Storage
        if (file) {
          const fileRef = storageRef(storage, `member_photos/${Date.now()}_${file.name}`);
          await uploadBytes(fileRef, file);
          const url = await getDownloadURL(fileRef);
          member.photoURL = url;
        }
        const newRef = push(membersRef);
        await set(newRef, member);
        return true;
      } catch (err) {
        console.error(err);
        throw err;
      }
    }

    // Done button workflow
    doneBtn.addEventListener('click', async () => {
      modalMsg.textContent = '';
      // check master password (client-side)
      const pass = masterPass.value || '';
      if (pass !== '-@LashkerA01') {
        modalMsg.textContent = 'Incorrect master password.';
        return;
      }

      // gather fields
      const member = {
        name: nameInput.value || '(no name)',
        customId: idInput.value || '',
        category: categoryInput.value || 'Hawker',
        detail: detailInput.value || '',
        joinDate: dateInput.value || (new Date()).toISOString(),
        createdAt: Date.now()
      };
      const file = photoInput.files && photoInput.files[0];

      if (!auth.currentUser) {
        // If not signed in, force sign in before final save
        modalMsg.textContent = 'You must sign in with Google to finish. Signing in...';
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          modalMsg.textContent = 'Sign-in required to save. ' + e.message;
          return;
        }
      }

      modalMsg.textContent = 'Saving...';
      try {
        // add who added it
        member.addedBy = auth.currentUser.email || auth.currentUser.uid;
        await saveMemberToFirebase(member, file);
        modalMsg.textContent = 'Saved successfully.';
        modal.style.display = 'none';
        // clear form + temp
        tempForm = {};
        photoInput.value = '';
        nameInput.value = '';
        idInput.value = '';
        detailInput.value = '';
        dateInput.value = '';
        masterPass.value = '';
      } catch (err) {
        modalMsg.textContent = 'Save failed: ' + err.message;
      }
    });

    // Real-time members listener
    let allMembers = {};
    const membersRef = dbRef(db, 'members');
    onValue(membersRef, (snapshot) => {
      const data = snapshot.val() || {};
      allMembers = data;
      renderList();
    });

    // Render list with filters
    function renderList() {
      const q = (globalSearch.value || '').toLowerCase();
      const cat = (categoryFilter.value || '');
      const entries = Object.entries(allMembers).map(([key, val]) => ({ key, ...val }));
      const filtered = entries.filter(m => {
        const matchesCat = !cat || (m.category === cat);
        const combined = `${m.name} ${m.customId} ${m.detail} ${m.category}`.toLowerCase();
        const matchesSearch = !q || combined.includes(q);
        return matchesCat && matchesSearch;
      }).sort((a,b) => (b.createdAt||0) - (a.createdAt||0));

      // sidebar small list
      memberList.innerHTML = '';
      filtered.forEach(m => {
        const el = document.createElement('div');
        el.className = 'memberCard';
        el.innerHTML = `
          <img src="${m.photoURL || 'https://via.placeholder.com/64?text=No'}" alt="photo"/>
          <div class="meta">
            <h3>${escapeHtml(m.name)} <span style="font-size:12px;color:#666">(${escapeHtml(m.category)})</span></h3>
            <p>${escapeHtml(m.customId)} • ${formatDate(m.joinDate)}</p>
          </div>
        `;
        memberList.appendChild(el);
      });

      // main list
      memberListMain.innerHTML = '';
      filtered.forEach(m => {
        const wrap = document.createElement('div');
        wrap.className = 'memberCard';
        wrap.style.marginBottom = '8px';
        wrap.innerHTML = `
          <img src="${m.photoURL || 'https://via.placeholder.com/64?text=No'}" alt="photo"/>
          <div class="meta">
            <h3>${escapeHtml(m.name)} <span style="font-size:12px;color:#666">(${escapeHtml(m.category)})</span></h3>
            <p><strong>ID:</strong> ${escapeHtml(m.customId)} • <strong>Joined:</strong> ${formatDate(m.joinDate)}</p>
            <p>${escapeHtml(m.detail || '')}</p>
            <p style="font-size:12px;color:#666">Added by: ${escapeHtml(m.addedBy || 'unknown')}</p>
          </div>
        `;
        memberListMain.appendChild(wrap);
      });
    }

    // Simple HTML-escape
    function escapeHtml(s='') {
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // Search / filter events
    globalSearch.addEventListener('input', renderList);
    categoryFilter.addEventListener('change', renderList);

    // Settings modal to show saved gmail logins
    settingsBtn.addEventListener('click', async () => {
      settingsModal.style.display = 'flex';
      settingsGmails.innerHTML = 'Loading...';
      const loginsRef = dbRef(db, 'logins');
      onValue(loginsRef, (snap) => {
        const data = snap.val() || {};
        const items = Object.values(data).reverse();
        if (!items.length) {
          settingsGmails.innerHTML = '<div class="muted">No sign-ins yet</div>';
          gmailList.textContent = 'No logins yet';
          return;
        }
        const html = items.map(i => `<div style="padding:6px;border-bottom:1px solid #eee">${escapeHtml(i.email)} <div style="font-size:12px;color:#666">at ${new Date(i.ts).toLocaleString()}</div></div>`).join('');
        settingsGmails.innerHTML = html;
        gmailList.textContent = items.map(x => x.email).join(', ');
      });
    });
    closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');

    // Click outside modal to close
    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
      if (e.target === settingsModal) settingsModal.style.display = 'none';
    });

    // Load initially
    renderList();

  </script>
</body>
</html>
